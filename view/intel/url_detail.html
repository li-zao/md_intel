<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/dist/css/all.min.css?{$v}">
    <link rel="stylesheet" href="/layui/css/layui.css?{$v}">
    <link rel="stylesheet" href="/dist/css/layout.min.css?{$v}">
    <link rel="stylesheet" href="/dist/css/jquery.json-viewer.css?{$v}">
    <link rel="stylesheet" href="/dist/css/sweetalert2.min.css?{$v}"/>
    <!-- 优先于common.js加载，否则tipMsg方法中Swal未定义 -->
    <script src="/dist/js/sweetalert2.all.min.js?{$v}" type="text/javascript" charset="utf-8"></script>
    <style>
        #desc-tip {
            color: #6b6b6b;
        }

        .layui-code-wrap {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            max-width: calc(100vw - 300px);
        }

        .layui-form-item {
            margin-bottom: 5px;
        }

        .layui-table-header {
            display: none;
        }

        input[readonly] {
            cursor: not-allowed;
        }

        .layui-input-affix {
            cursor: pointer;
        }

        .layui-icon-none {
            color: rgba(0, 0, 0, .8);
            pointer-events: auto !important;
            cursor: pointer;
        }

        .json-container {
            margin: 2px 0 0 20px;
        }

        .layui-input-group {
            width: -webkit-fill-available;
        }

        .layui-input-group > .layui-input-suffix {
            width: 20px;
        }

        .layui-layer-tips .layui-layer-content {
            font-size: 15px;
            word-break: auto-phrase;
            word-wrap: anywhere;
        }

        .layui-form-item .layui-inline {
            width: 48%;
        }

        .layui-form-pane xm-select {
            margin: 0 !important;
        }
    </style>
</head>
<body>
<div class="">
    <fieldset class="layui-elem-field">
        <legend>URL 情报详情</legend>
        <div class="layui-field-box">
            <div class="layui-row">
                <div class="layui-col-md6">
                    <div class="layui-row">
                        <div class="layui-col-md12">
                            <form class="layui-form layui-form-pane" lay-filter="url-detail" action="" id="detail-form">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">序号</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="id" readonly lay-affix="none fa-light fa-copy"
                                               lay-filter="copy" lay-options="{split: true}" class="layui-input"
                                               id="record-id">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">URL</label>
                                    <div class="layui-input-group">
                                        <input type="text" name="url" readonly lay-affix="none fa-light fa-copy"
                                               lay-filter="copy" lay-options="{split: true}" class="layui-input"
                                               id="url-input-id">
                                        <div class="layui-input-split layui-input-suffix" style="cursor: pointer;">
                                            <i class="fa-light fa-arrow-up-right-from-square"></i>
                                        </div>
                                        <div class="layui-input-split layui-input-suffix" style="cursor: pointer;">
                                            <i class="fa-light fa-layer-group"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">格式化URL</label>
                                    <div class="layui-input-group">
                                        <input type="text" name="clean_url" readonly lay-affix="none fa-light fa-copy"
                                               lay-filter="copy" lay-options="{split: true}" class="layui-input"
                                               id="clean-url-input-id">
                                        <div class="layui-input-split layui-input-suffix" style="cursor: pointer;">
                                            <i class="fa-light fa-arrow-up-right-from-square"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">访问URL</label>
                                    <div class="layui-input-group">
                                        <input type="text" name="real_url" readonly lay-affix="none fa-light fa-copy"
                                               lay-filter="copy" lay-options="{split: true}" class="layui-input"
                                               id="real-url-input-id">
                                        <div class="layui-input-split layui-input-suffix" style="cursor: pointer;">
                                            <i class="fa-light fa-arrow-up-right-from-square"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">域名</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="domain" readonly lay-affix="none fa-light fa-copy"
                                               lay-filter="copy" lay-options="{split: true}" class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">Hash</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="hash" readonly lay-affix="none fa-light fa-copy"
                                               lay-filter="copy" lay-options="{split: true}" class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">邮件时间</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="created_at" readonly lay-affix="none fa-light fa-copy"
                                               lay-filter="copy" lay-options="{split: true}" class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">预测</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="predict_str" readonly
                                               lay-affix="none fa-light fa-arrows-rotate" lay-filter="refresh"
                                               lay-options="{split: true}" class="layui-input predict_0">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <div class="layui-inline">
                                        <label class="layui-form-label">HTTP</label>
                                        <div class="layui-input-block">
                                            <input type="text" name="http" readonly class="layui-input">
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                        <label class="layui-form-label">Vector</label>
                                        <div class="layui-input-block">
                                            <input type="text" name="vector" readonly class="layui-input">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <div class="layui-inline">
                                        <label class="layui-form-label">分类</label>
                                        <div class="layui-input-block" id="type-select">
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                        <label class="layui-form-label">集合</label>
                                        <div class="layui-input-block" id="set-select">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <div class="layui-inline">
                                        <label class="layui-form-label">类型</label>
                                        <div class="layui-input-block" id="category-select">
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                        <label class="layui-form-label">来源</label>
                                        <div class="layui-input-block" id="source-select">
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <a class="layui-btn layui-btn-sm op-btn">Normal</a>
                                    <a class="layui-btn layui-btn-sm op-btn">502</a>
                                    <a class="layui-btn layui-btn-sm op-btn">404</a>
                                    <a class="layui-btn layui-btn-sm op-btn">400</a>
                                    <a class="layui-btn layui-btn-sm op-btn">Host</a>
                                    <a class="layui-btn layui-btn-sm op-btn">白页</a>
                                    <a class="layui-btn layui-btn-sm op-btn">JS 跳转</a>
                                    <a class="layui-btn layui-btn-sm op-btn">不可用短链</a>
                                    <a class="layui-btn layui-btn-sm op-btn">恶意域名</a>
                                </div>
                                <div class="layui-form-item layui-form-text">
                                    <label class="layui-form-label">评论 <span id="desc-tip">{$descTime}</span></label>
                                    <div class="layui-input-block">
                                        <textarea rows="6" name="desc" class="layui-textarea"
                                                  id="desc-text">{$desc|raw}</textarea>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="layui-row">
                        <div class="layui-col-md12">
                            <table class="layui-hide" id="file-table" lay-filter="file-table"></table>
                        </div>
                    </div>
                </div>
                <div class="layui-col-md6">
                    <div class="layui-row">
                        <div class="layui-col-md12">
                            <pre class="layui-code url-html-text" lay-options="{}">{$urlHtml}</pre>
                        </div>
                    </div>
                    <div class="layui-row">
                        <div class="layui-col-md12">
                            <pre class="layui-code url-html-text" lay-options="{}">{$urlResponse}</pre>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row layui-hide">
                <div class="layui-col-md12">
                    <pre id="json-renderer-vector" class="json-container"></pre>
                </div>
            </div>
        </div>
    </fieldset>
</div>
</body>
<script type="text/html" id="file-toolbar">
    <button type="button" class="layui-btn layui-btn-sm" id="url-screen">
        <i class="layui-icon layui-icon-upload">
        </i> 上传
    </button>
</script>
<script type="text/html" id="file-bar">
    <div class="layui-btn-group">
        <!-- <a class="layui-btn layui-btn-sm" lay-event="download"><i class="fa-light fa-download"></i> 下载</a> -->
        <a class="layui-btn layui-btn-normal layui-btn-sm layui-hide" lay-event="preview"><i
            class="fa-light fa-image"></i> 预览</a>
        <a class="layui-btn layui-btn-danger layui-btn-sm" lay-event="del"><i class="fa-light fa-trash-can"></i>
            删除</a>
    </div>
</script>

<script src="/layui/layui.js?{$v}" type="text/javascript" charset="utf-8"></script>
<script src="/dist/js/jquery.min.js?{$v}" type="text/javascript" charset="utf-8"></script>
<script src="/dist/js/common.js?{$v}" type="text/javascript" charset="utf-8"></script>
<script src="/dist/js/jquery.json-viewer.js?{$v}" type="text/javascript" charset="utf-8"></script>
<script src="/dist/js/jquery.debounce-1.0.5.js?{$v}" type="text/javascript" charset="utf-8"></script>
<script src="/dist/js/xm-select.js?v={$v}" type="text/javascript" charset="utf-8"></script>
<script src="/dist/js/viewer.min.js?v={$v}" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
    let source = renderXmSelect('#source-select', JSON.parse('{$source|json_encode|raw}'), 'source', true, {initValue: [{$record["source"]}]});
    let category = renderXmSelect('#category-select', JSON.parse('{$category|json_encode|raw}'), 'category', true, {initValue: [{$record["category"]}]});
    let set = renderXmSelect('#set-select', JSON.parse('{$set|json_encode|raw}'), 'set', true, {initValue: [{$record["set"]}]});
    let type = renderXmSelect('#type-select', JSON.parse('{$type|json_encode|raw}'), 'type', true, {initValue: [{$record["type"]}]});
    layui.use(function () {
        var hash = '{$hash}';
        var id = '{$id}';
        var fileTableFlag = 'url_file';
        var fileColWidDict = loadTableCols(fileTableFlag, 'width');
        var fileColHideDict = loadTableCols(fileTableFlag);
        var descText = $('#desc-text');
        $('body').on('keydown', function (event) {
            if (event.keyCode == 27) {
                if (parent.layer) {
                    parent.layer.closeAll();
                }
            }
        }).on('click', '.op-btn', function () {
            let _this = $(this);
            postDesc(descText.val() + ' ' + _this.text());
        });
        $('#desc-text').keyup($.debounce(function () {
            let _this = $(this);
            $('#desc-tip').html('保存中...');
            postDesc(_this.val());
            // $.ajax({
            //     type: "POST",
            //     data: {id: id, desc: _this.val()},
            //     url: "/intel/urlDesc",
            //     success: function (result) {
            //         if (result.code) {
            //             tipError('失败' + result.msg);
            //             return false;
            //         }
            //         $('#desc-tip').html(result.data.desc_time + ' 已保存');
            //     }
            // });
        }, 700));
        $('.fa-arrow-up-right-from-square').on('click', function () {
            let url = $(this).closest('.layui-input-group').find('.layui-input').val();
            if (url) {
                window.open(url, '_blank').focus();
            }
        });
        $('.fa-layer-group').on('click', function () {
            let url = $(this).closest('.layui-input-group').find('.layui-input').val();
            if (url) {
                window.open('/intel/urlCacheView?id=' + id, '_blank').focus();
            }
        });
        $('.layui-input').on('click', function () {
            let _input = $(this);
            let _id = _input.attr('id');
            if (!_id) {
                return false;
            }
            const computedStyle = getComputedStyle(this);
            let _w = getCanvasTextWidth(
                this.value,
                `${computedStyle.fontSize} ${computedStyle.fontFamily}`
            );
            console.log(_w, _input.width());
            if (_w > _input.width()) {
                layui.layer.tips(_input.val(), this, {
                    tips: [1, '#16baaa'],
                    time: 5000,
                    maxWidth: 2900,
                });
            }
        });
        layui.form.val('url-detail', {
            "id": "{$record['id']}",
            "url": "{$record['url'] ?? ''}",
            "clean_url": "{$record['clean_url'] ?? ''}",
            "real_url": "{$record['real_url'] ?? ''}",
            "created_at": "{$record['created_at'] ?? ''}",
            "predict_str": "{$record['predict_str'] ?? ''}",
            "domain": "{$record['domain'] ?? ''}",
            "hash": "{$record['hash'] ?? ''}",
            "http": "{$http['updated_at'] ?? ''}",
            "vector": "{$vector['updated_at'] ?? ''}",
        });
        $('.layui-icon-none').removeClass('layui-icon');
        layui.form.on('input-affix(copy)', function (data) {
            copyToClipboard(data.elem.value);
            tipInfo('复制成功', {timer: 400});
        });
        layui.form.on('input-affix(refresh)', function (data) {
            $(data.elem).val('查询中...');
            let recordId = $('#record-id').val();
            let spinClass = 'fa-spin';
            let icon = $(data.elem).siblings('.layui-input-affix').find('i.layui-icon-none');
            icon.addClass(spinClass);
            $.ajax({
                url: '/intel/urlPredict',
                type: 'POST',
                data: {
                    id: recordId
                },
                dataType: 'json',
                success: function (res) {
                    if (res.code) {
                        tipError(res.msg);
                        return false;
                    }
                    $(data.elem).val(res.data.predict_str);
                    if (res.data.err) {
                        tipInfo(res.data.err);
                    }
                },
                complete: function () {
                    icon.removeClass(spinClass);
                },
            })
        });
        var screenTable = layui.table.render({
            elem: '#file-table',
            url: '/intel/urlScreenList/',
            where: {
                hash: hash,
            },
            toolbar: '#file-toolbar',
            page: false,
            limit: 50,
            cols: [[
                {
                    field: 'base',
                    title: '名称',
                    width: (fileColWidDict.get('base') ?? D_COL_WID),
                    hide: fileColHideDict.get('base')
                },
                {
                    field: 'src',
                    title: '路径',
                    width: (fileColWidDict.get('src') ?? D_COL_WID),
                    hide: fileColHideDict.get('src'),
                    escape: false
                },
                {
                    fixed: 'right', title: '操作', width: 228, templet: function (d) {
                        let con = $('#file-bar').clone();
                        con = $(con.html());
                        if (d.icon.indexOf('fa-image') > -1) {
                            con.find('a.layui-hide').removeClass('layui-hide');
                        }
                        return con.prop('outerHTML');
                    }
                }
            ]]
        });
        layui.table.on('tool(file-table)', function (obj) {
            switch (obj.event) {
                case "download":
                    if (obj.data.id) {
                        window.open('/file/download?bucket=url&id=' + obj.data.id);
                    }
                    break;
                case 'del':
                    delFile(obj.data);
                    break;
                case 'preview':
                    openTableImages(obj);
                    break;
            }
        });
        layui.table.on('colResized(file-table)', function (obj) {
            saveTableColWidth(obj, fileTableFlag);
        });
        layui.table.on('colToggled(file-table)', function (obj) {
            saveTableCols(obj, fileTableFlag);
        });
        layui.code({
            elem: '.url-html-text'
        });
        renderUpload();

        function postDesc(desc) {
            $.ajax({
                type: "POST",
                data: {id: id, desc: desc},
                url: "/intel/urlDesc",
                success: function (result) {
                    if (result.code) {
                        tipError('失败' + result.msg);
                        return false;
                    }
                    $('#desc-tip').html(result.data.desc_time + ' 已保存');
                    $('#desc-text').val(result.data.desc);
                }
            });
        }

        function delFile(data) {
            let src = data.src;
            if (!src) {
                tipError('参数错误');
                return false;
            }
            delConfirm(data.base).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: "POST",
                        dataType: "json",
                        url: '/intel/urlScreenDel',
                        data: {src: src, hash: hash},
                        success: function (result) {
                            if (result.code) {
                                tipError(result.msg);
                                return false;
                            }
                            tipSuccess('操作成功');
                            layui.table.reloadData('file-table');
                        },
                        error: function (data) {
                            tipError('请求失败');
                        }
                    });
                }
            });
        }

        function renderUpload() {
            var uploadInst = layui.upload.render({
                elem: '#url-screen',
                accept: 'file',
                url: '/file/docFile',
                done: function (res) {
                    if (res.code) {
                        tipError(res.msg);
                        return false;
                    }
                    addDoc(res.data);
                },
                error: function () {
                    tipError('上传出错，请检查文件或联系管理员');
                }
            });
        }

        function addDoc(data) {
            if (!data || !data.src) {
                tipError('参数错误');
                return false;
            }
            let params = {src: data.src, hash: hash};
            $.ajax({
                type: 'POST',
                dataType: "json",
                url: '/intel/urlScreen',
                data: params,
                success: function (result) {
                    if (result.code) {
                        tipError(result.msg);
                        return false;
                    }
                    tipSuccess('操作成功');
                    layui.table.reloadData('file-table');
                },
                error: function (data) {
                    tipError('请求失败');
                }
            });
        }

        function getCanvasTextWidth(text, font) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.font = font;  // 需指定完整字体样式，如 "14px Arial"
            return ctx.measureText(text).width;
        }
    });
    {if !empty($vectorLog)}
    let vector = JSON.parse({$vectorLog|json_encode|raw});
    $('#json-renderer-vector').jsonViewer(vector, {collapsed: {$collapsed}});
    {/if}
</script>